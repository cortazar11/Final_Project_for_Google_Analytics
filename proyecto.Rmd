---
title: "PROYECTO"
output: html_document
date: '2022-12-13'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
library(tidyverse)
library(readr)
library(dplyr)
library(ggplot2)
library(data.table)
library(lubridate)
library(generics)
library(stringi)
library(descriptr)
library(psych)
library(swirl)
```

Este trabajo está realizado para el proyecto final de la certificación profesional de Google Analytics en la plataforma Coursera, pudiendo elegirse dos casos prácticos. De los dos proyectos a elegir he optado por el caso práctico 1: ¿Cómo lograr el éxito rápido de un negocio de bicicletas compartidas?

He seguido los pasos recomendados en el curso y que son: preguntar, preparar, procesar, analizar, compartir, actuar.

# PREGUNTAR

En este paso se define el problema que pretende resolverse para entender plenamente las expectativas de los interesados. La empresa ficticia Ciclystic tiene dos tipos de clientes: ciclistas ocasionales que pagan la bici solo en las ocasiones que las toman y ciclistas que han hecho una suscripcion anual pudiendolas tomar tanta veces como quieran durante la suscripcion. La directora de marketing cree que el éxito futuro de la empresa depende de maximizar el ńumero de suscripciones anuales.

Por tanto el problema que se plantea es entender qué diferencias existen en el uso de bicicletas Cyclistic entre los ciclistas ocasionales y los que tienen una suscripción anual. A través de este conocimiento, se diseñará una nueva estrategia de marketing para convertir los ciclistas ocasionales en suscriptores anuales.

En este paso tenemos que tener presente quienes son los interesados: los ejecutivos de Cyclistic, que deben aprobar las recomendaciones a partir del conocimiento que obtengamos. Pero tambien la directora de marketing, que es de dónde parte la solicitud de análisis.

Así pues estableceré estrategias de comunicación con estos interesados: la directora de marketing y los ejecutivos, y que ayudarán a enfocar el problema.

En resumen, las tres preguntas en concreto que guiarán el programa de marketing son:

1. ¿En qué se diferencian los socios anuales y los ciclistas ocasionales con respecto al uso de las bicicletas de Cyclistic?

2. ¿Por qué los ciclistas ocasionales comprarían membresías anuales de Cyclistic?

3. ¿Cómo puede usar Cyclistic los medios digitales para influenciar a los ciclistas ocasionales a convertirse en miembros?

De estas tres preguntas, la directora de marketing me asigna, como analista de datos, la primera pregunta:
¿En qué se diferencian los socios anuales y los ciclistas ocasionales con respecto al uso de las bicicletas de Cyclistic?

# PREPARAR

Para realizar el análisis los datos históricos de los viajes de Cyclistic.

La fuente de datos es un enlace a la nube de amazon aws en donde se sencuentran múltiples ficheros en formato csv de la empresa ficticia Cyclistic. Por tanto se trata de una fuente secundaria.

Hay tres tipos de ficheros con dos diferente clases de datos:

En el primero estan los datos correspondientes a los trayectos que se realizan en las bicicletas.
En el segundo, los datos correspondientes a las estaciones donde estan colocadas las bicicletas.

Para este ejercicio y tal y como se indica en las instrucciones se utilizaran los datos de los 12 últimos meses, por lo que tendremos ficheros correspondientes a los meses que van desde Diciembre 2021 a Noviembre 2022





# PROCESAR

## Limpieza ficheros de viajes 

En primer lugar hacemos una lista de las rutas a los 12 ficheros que vamos a utilizar

```{r}
  list_files <- list.files("/home/miguel/CURSO_DATA_ANALYSIS/Caso_Práctico/DATA_12MONTHS", full.names= TRUE)
  list_files
```

Despues leemos con el comando read_csv todos los ficheros indicados en las rutas anteriores para crear un marco de datos de cada fichero y añadimos una columna mas en cada marco: la de mes, que se derivará del nombre de cada fichero donde esta escrito el mes a que corresponde el fichero (202112-divvy-tripdata.csv, etc)

```{r}
    result <- lapply(list_files,
                 function(x){
                   df <- read_csv(x)
                   df$month <- x
                   df$month <- stri_replace_all_regex(df$month,
                                                      pattern=c('/home/miguel/CURSO_DATA_ANALYSIS/Caso_Práctico/DATA_12MONTHS/',   
                                                                '-divvy-tripdata.csv','-divvy-publictripdata.csv'),
                                                      replacement=c('', '', '' ),
                                                      vectorize=FALSE)
                   df$diff <- df$ended_at - df$started_at
                   df$diff_double <- as.double(df$diff, units="auto")
                   df$diff_format <- hms::hms(seconds_to_period(df$diff))
                   df
                 }
)
```
El anterior proceso nos da una lista de marcos de datos correspondientes cada uno a los 12 meses que analizaremos.

```{r}
class(result)
```
Lo que tenemos que hacer ahora con esta lista de marcos de datos es convergerlos todos en un único marco de datos donde el mes, en vez de ser el nombre del fichero será uno de los campos de ese marco, para lo cual utilizaremos el comando *do.call* con el cual en vez de aplicar una funcion a los elementos de una lista, lo que hacemos es incorporar una lista como argumentos de una funcion; en este caso *rbind*.

```{r}
    df <- do.call(rbind,result)
```


Una primera lectura al marco de datos resultante nos da los siguientes resultados.

```{r}
    colnames(df)
    head(df)
```

En este paso de limpieza podemos comprobar como en la diferencia del tiempo de recogida de la bicicleta y el tiempo de dejarla hay valores negatios y valores que son cero, por lo que tendremos que eliminar los registros correspondientes a estos valores.

```{r}
    df <- subset(df, !sign(df$diff_double)==-1)
    df <- subset(df, !sign(df$diff_double)==0)
```

1. Convertimos algunas variables como *rideable type* and *member_casual* de carácter a factor.

```{r}
    df$member_casual <- as.factor(df$member_casual)
    df$rideable_type <- as.factor(df$rideable_type)
```


Con lo que pasamos al siguiente apartado que será análisis y gráficos.

# ANALIZAR


2. En una primera introducción al análisis tenemos los siguientes resultado:

```{r}
    glimpse(df)
    ds_screener(df)
```
Lo que nos da 5.733.451 registros y 16 variables



2. Hacemos un gráfico para tener una visión general de cuantos eran ciclistas ocasionales y cuantos tenían una suscripción anual.
Para ello primeramente tenemos que agrupar por meses los datos. Para ello primero convertimos el campo *member_casual* de character en factor y seguidamente agrupamos los datos por meses.

```{r}
     by_month <- df %>%
               group_by(month) %>%
               count(member_casual)
    by_month
```

Seguidamente hacemos un gráfico de barras que nos en las barras el ńumero de cilistas ocasionales y suscriptores, agrupados por mes.

```{r}
    p <- ggplot(by_month, aes(fill=member_casual,y=n,x=month )) +
          geom_bar(position="dodge", stat="identity")
    p
```
De aqui podemos sacar ya algunas conclusiones:
Entre Mayo y Septiembre vemos como aumenta el número de personas que utilizan la bici, coincidiendo con la mejora del tiempo.
Por otro lado vemos como el aumento es tanto de ciclistas ocasionales como de suscriptores en los meses de verano, a diferencia del resto del año donde los suscriptores son inmensa mayoria de los que utilizan la bici.

Ahora veremos el tipo de bicicleta que se usa desglosadas por mes:

Primero convertimos en factor la variable tipo de bicicleta

```{r}

by_month_rideable_type <- df %>%
              group_by(month) %>%
              count(rideable_type)
by_month_rideable_type
```
Y ahora hacemos el gráfico, igual que antes pero con esta otra variable: tipo de bicicleta:

```{r}
    q <- ggplot(by_month_rideable_type, aes(fill=rideable_type,y=n,x=month )) +
          geom_bar(position="dodge",stat="identity")
    q
```
Comprobamos que las bicicletas acopladas son las que menos se usan. En cuanto a las otras dos, vemos que las bicicletas clásicas se usan mas cuando el tiempo mejora: a partir de Mayo y hasta Julio se usan mas que las eléctricas. El resto de los meses son las eléctricas las mas usadas.

Aqui tenemos las primera estadística descriptiva agrupadas por meses, utilizando el paquete *psych*

```{r}
    stats_by_month <- describeBy(df$diff_double, df$month, mat = TRUE) 
    stats_by_month
```

<!-- Means of time diference grouped by month and by member_casual -->

```{r}
    stats_by_month_by_membercasual <- describeBy(df$diff_double, list(df$month, df$member_casual), mat = TRUE)
    stats_by_month_by_membercasual
```

Grafico correspondiente

```{r}
    q <-  ggplot(stats_by_month_by_membercasual,aes(x = group1,
                y = mean,
                group = group2)) +
          geom_line(aes(col = group2)) +
          geom_point()
    q
```
Aqui vemos claramente como la media del tiempo recorrido en bicicleta por los ciclistas ocasionales es mucho mayor que en los ciclistas que tienen una suscripcion, en todas las meses del año. Ahora haría falta saber si hay una relación significativa entre el tiempo de uso de la bicicleta y el ser ciclista ocasional o tener una suscripcion. O sea, tendremos que ver si el tiempo de uso de la bicicleta puede predecir si el ciclista es ocasional o suscriptor.

## Test estadístico ANOVA para modelar la variable tiempo de uso de la bicicleta en funcion del tipo de usuario (ocasional, suscriptor).

```{r}
   # Test estadístico ANOVA
    result <- aov(diff_double ~ member_casual, data = df)
    summary(result)
```
El valor F, que es muy alto, nos viene a indicar que es probable que la variación de la variable tiempo de uso de la bicicleta causada por la variable tipo de usuario sea real y no debida al azar.

Lo cual queda confirmado por el valor de p, que es extremadamente pequeño (p=0.0000000000000002). Este valor describe la probabilidad de hallar un determinado conjunto de observaciones si la hipótesis nula fuera cierta, o sea, que no hubiera ninguna relación entre las variables.
Cuanto mas pequeño es el valor p , mas probable es el rechazar la hipótesis nula y aceptar la alternativa, esto es, que hay relación entre las dos variables. Como el valor p es extremadamente pequeño, podemos concluir que el tiempo de uso de la bicicleta (la diferencia entre el momento en que se coge la bicicleta y el momento en que se deja) viene causada por el tipo de usuario.
Sin embargo tenemos que tener en cuenta que la varianza residual es muy alta; esto es, hay mucha parte de la variación en el tiempo de uso de la bicicleta que no es explicada por la variable tipo de usuario.

# COMPARTIR

# ACTUAR

